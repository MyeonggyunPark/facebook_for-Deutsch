<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="../static/img/logo_icon.png" type="image/png">
  <title>이사한 도시 보기</title>
  <style>
    html {
      scroll-padding-top: 100px; /* sticky header height offset */
    }
  </style>
</head>
<body class="bg-gray-50">

  <!-- 메뉴바 -->
  <div class="w-full bg-cyan-100 shadow-md sticky top-0 z-[9999]">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex gap-3">
        <a href="../index.html">
          <img class="size-[60px]" src="../static/img/logo_icon.png" alt="로고 아이콘">
        </a>
        <div class="text-2xl sm:text-xl font-bold mt-[12px]">이사한 도시 보기</div>
      </div>
      <!-- 햄버거 버튼 (모바일 전용) -->
      <button id="menu-toggle" class="sm:hidden text-gray-700 focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>

      <!-- 메뉴 리스트 (PC용) -->
      <div class="hidden sm:flex gap-3">
        <a href="https://forms.gle/J4KzCDTXwevFv9Pv9" target="_blank" class="border-4 border-white bg-white text-gray-800 text-[16px] font-semibold py-2 px-4 rounded-full shadow hover:border-[#fabc02] hover:bg-blue-50 transition">
          문의하기
        </a>
        <a href="map.html" class="border-4 border-white bg-white text-gray-800 text-[16px] font-semibold py-2 px-4 rounded-full shadow hover:border-[#fabc02] hover:bg-blue-50 transition">
          이사한 도시 보기
        </a>
        <a href="rieviews.html" class="border-4 border-white bg-white text-gray-800 text-[16px] font-semibold py-2 px-4 rounded-full shadow hover:border-[#fabc02] hover:bg-blue-50 transition">
          리뷰 보기
        </a>
      </div>
    </div>

    <!-- 토글 메뉴 (모바일 전용) -->
    <div id="mobile-menu" class="sm:hidden hidden px-4 pb-4">
      <a href="https://forms.gle/J4KzCDTXwevFv9Pv9" class="block w-full text-center border-4 border-white bg-white text-gray-800 text-md font-semibold py-2 rounded-full shadow hover:border-[#fabc02] mb-2 hover:bg-blue-50 transition">
        문의하기
      </a>
      <a href="map.html" class="block w-full text-center border-4 border-white bg-white text-gray-800 text-md font-semibold py-2 rounded-full shadow hover:border-[#fabc02] mb-2 hover:bg-blue-50 transition">
        이사한 도시 보기
      </a>
      <a href="rieviews.html" class="block w-full text-center border-4 border-white bg-white text-gray-800 text-md font-semibold py-2 rounded-full shadow hover:border-[#fabc02] hover:bg-blue-50 transition">
        리뷰 보기
      </a>
    </div>
  </div>

  <script>
    const toggle = document.getElementById('menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');

    toggle.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });
  </script>

    <div class="max-w-6xl mx-auto px-4 mt-12">
      <span class="bg-blue-100 text-blue-700 text-xs font-medium px-2 py-0.5 rounded-md shadow-sm ml-2">since 2020</span>
      <!-- 지도 -->
      <div id="map" class="relative z-0 w-full h-[400px] sm:h-[450px] md:h-[500px] border-4 border-black rounded-xl mt-3 mb-6"></div>

      <div class="flex justify-center gap-2">
        <p class="text-2xl pt-4">⬇️</p>
        <div class="flex flex-col">
          <span class="text-gray-500 font-semibold text-base">주 이름을 클릭하면 도시 버튼이 나타납니다.</span>
          <span class="text-gray-500 font-semibold text-base">도시 버튼을 누르면 지도에 위치가 표시됩니다.</span>
        </div>
      </div>

      <div id="city-list" class="flex flex-col gap-8 mb-7 mt-3"></div>
    </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const root = document.scrollingElement || document.documentElement; 
    
    const map = L.map("map").setView([51.2, 10.5], 6.5);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const blueIcon = new L.Icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
      shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    });

    const redIcon = new L.Icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
      shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41],
    });

    const states = {
      "Baden-Württemberg": [
        { name: 'Freiburg<br>(프라이부르크)', lat: 47.999, lng: 7.8421 },
        { name: 'Karlsruhe<br>(칼스루에)', lat: 49.006889, lng: 8.403653 },
        { name: 'Mannheim<br>(만하임)', lat: 49.4875, lng: 8.466 },
      ],
      "Bayern": [
        { name: 'Augsburg<br>(아우크스부르크)', lat: 48.3717, lng: 10.8985 },
        { name: 'Nürnberg<br>(뉘른베르크)', lat: 49.460983, lng: 11.061859 },
        { name: 'Würzburg<br>(뷔르츠부르크)', lat: 49.7913, lng: 9.9534 },
      ],
      "Berlin": [
        { name: 'Berlin<br>(베를린)', lat: 52.520008, lng: 13.404954 },
      ],
      "Hamburg": [
        { name: 'Hamburg<br>(함부르크)', lat: 53.5511, lng: 9.9937 },
      ],
      "Hessen": [
        { name: 'Bad Soden<br>(바트 조덴)', lat: 50.1398, lng: 8.5046 },
        { name: 'Eschborn<br>(애쉬본)', lat: 50.1436, lng: 8.5715 },
        { name: 'Frankfurt<br>(프랑크푸르트)', lat: 50.1109, lng: 8.6821 },
        { name: 'Frankfurt Flughafen<br>(프랑크푸르트 공항)', lat: 50.05, lng: 8.5706 },
        { name: 'Liederbach am Taunus<br>(리더바흐 암 타누스)', lat: 50.1225, lng: 8.4936 },
        { name: 'Marburg<br>(마르부르크)', lat: 50.810001, lng: 8.770833 },
      ],
      "Niedersachsen": [
        { name: 'Hannover<br>(하노버)', lat: 52.3759, lng: 9.732 },
        { name: 'Osnabrück<br>(오스나브뤼크)', lat: 52.2799, lng: 8.0472 },
      ],
      "Nordrhein-Westfalen": [
        { name: 'Aachen<br>(아헨)', lat: 50.775555, lng: 6.083611 },
        { name: 'Bielefeld<br>(빌레펠트)', lat: 52.0302, lng: 8.5325 },
        { name: 'Bochum<br>(보훔)', lat: 51.4818, lng: 7.2162 },
        { name: 'Bonn<br>(본)', lat: 50.7374, lng: 7.0982 },
        { name: 'Detmold<br>(데트몰트)', lat: 51.938, lng: 8.8732 },
        { name: 'Dortmund<br>(도르트문트)', lat: 51.514244, lng: 7.468429 },
        { name: 'Düsseldorf<br>(뒤셀도르프)', lat: 51.2277, lng: 6.7735 },
        { name: 'Essen<br>(에센)', lat: 51.455643, lng: 7.011555 },
        { name: 'Hagen<br>(하겐)', lat: 51.3671, lng: 7.4633 },
        { name: 'Hamm<br>(함)', lat: 51.683334, lng: 7.816667 },
        { name: 'Köln<br>(쾰른)', lat: 50.9375, lng: 6.9603 },
        { name: 'Krefeld<br>(크레펠트)', lat: 51.3388, lng: 6.5853 },
        { name: 'Münster<br>(뮌스터)', lat: 51.9607, lng: 7.6261 },
        { name: 'Wuppertal<br>(부퍼탈)', lat: 51.2562, lng: 7.1508 },
      ],
      "Rheinland-Pfalz": [
        { name: 'Koblenz<br>(코블렌츠)', lat: 50.3569, lng: 7.5889 },
        { name: 'Mainz<br>(마인츠)', lat: 49.9929, lng: 8.2473 },
      ],
      "Saarland": [
        { name: 'Saarbrücken<br>(자르브뤼켄)', lat: 49.2402, lng: 6.9969 },
      ],
      "Sachsen": [
        { name: 'Leipzig<br>(라이프치히)', lat: 51.3397, lng: 12.3731 },
        { name: 'Zwickau<br>(츠비카우)', lat: 50.7189, lng: 12.4964 },
      ],
      "Sachsen-Anhalt": [
        { name: 'Halle&nbsp;(Saale)<br>(할레잘레)', lat: 51.4828, lng: 11.9692 },
      ],
      "기타 (해외)": [
        { name: 'Brüssel<br>(브뤼셀)', lat: 50.8503, lng: 4.3517 },
        { name: 'Paris<br>(파리)', lat: 48.8566, lng: 2.3522 },
      ]
    };

    let entries = Object.entries(states);
    let etc = entries.find(([key]) => key === "기타 (해외)");
    entries = entries.filter(([key]) => key !== "기타 (해외)");

    const sortedStates = Object.fromEntries([
      ...entries.sort((a, b) => a[0].localeCompare(b[0])),
      etc
    ]);

    const markers = {};
    let activeMarker = null;
    const allMarkers = [];
    const cityListEl = document.getElementById("city-list");

    Object.entries(sortedStates).forEach(([stateName, cities]) => {
      const container = document.createElement("div");
      container.className = "border border-gray-300 rounded-xl shadow bg-white";

      const toggleButton = document.createElement("button");
      toggleButton.className = "w-full text-left p-4 text-lg font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-t-xl";
      toggleButton.textContent = stateName;

      const cityContainer = document.createElement("div");
      cityContainer.className = "p-4 hidden";

      const cityFlex = document.createElement("div");
      cityFlex.className = "flex flex-wrap gap-2 justify-center";

      toggleButton.addEventListener("click", () => {
        // 1) 토글 "전"에 아래 끝에 붙어있는지 체크
        const atBottom =
          Math.abs(root.scrollHeight - (root.scrollTop + root.clientHeight)) < 2;

        // 기존 토글
        cityContainer.classList.toggle("hidden");

        if (!cityContainer.classList.contains("hidden")) {
          // 2) 레이아웃이 실제로 늘어난 뒤에 계산하도록 다음 프레임에서 처리
          requestAnimationFrame(() => {
            const rect = container.getBoundingClientRect();
            const vh = root.clientHeight;

            // 열렸는데 화면 아래로 넘친 만큼(보여야 할 부분이 가려진 양)
            const overflow = rect.bottom - vh;

            if (atBottom) {
              // 3-a) 이미 페이지 맨 아래였다면 → 새로 늘어난 만큼의 "진짜" 끝까지 스크롤
              root.scrollTo({ top: root.scrollHeight, behavior: "smooth" });
            } else if (overflow > 0) {
              // 3-b) 하단 근처(넘치는 경우)만 필요한 만큼만 부드럽게 아래로 이동
              window.scrollBy({ top: overflow + 12, behavior: "smooth" }); // +12는 여백
            }
            // 3-c) 중간 위치면 스크롤 변화 없음
          });
        }
      });
        
      cities.forEach((loc) => {
        const marker = L.marker([loc.lat, loc.lng], { icon: blueIcon })
          .addTo(map)
          .bindPopup(`<b>${loc.name}</b>`);
        markers[loc.name] = marker;
        allMarkers.push(marker);

        const btn = document.createElement("button");
        btn.innerHTML = loc.name;
        btn.className =
          "bg-gradient-to-r from-blue-100 to-cyan-100 text-gray-800 border-2 border-blue-200 rounded-xl px-4 py-2 text-sm sm:text-xs font-bold shadow hover:border-blue-500 hover:text-blue-600 transition";

        btn.addEventListener("click", () => {
          if (activeMarker) {
            activeMarker.setIcon(blueIcon);
            activeMarker.setZIndexOffset(0);
          }
          marker.setIcon(redIcon);
          marker.setZIndexOffset(1000);
          marker.openPopup();
          activeMarker = marker;

          document.getElementById("map").scrollIntoView({ behavior: "smooth", block: "start" });
        });

        cityFlex.appendChild(btn);
      });

      cityContainer.appendChild(cityFlex);
      container.appendChild(toggleButton);
      container.appendChild(cityContainer);
      cityListEl.appendChild(container);
    });

    const group = new L.featureGroup(allMarkers);
    map.fitBounds(group.getBounds().pad(0.15));
  </script>
</body>
</html>

